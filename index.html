<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8">
  <title>Vernerunde - Sjekkliste</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f8f8f8; margin: 0; padding: 20px; }
    h1 { color: darkred; text-align: center; }
    .container { max-width: 1200px; margin: auto; background: white; padding: 20px; border-radius: 10px; }
    .section-title { margin-top: 30px; font-weight: bold; font-size: 1.2em; color: #444; border-bottom: 2px solid #ccc; padding-bottom: 5px; }
    .check-item { display: flex; flex-direction: column; margin-bottom: 20px; }
    .question { font-weight: bold; color: #333; font-size: 1rem; margin-bottom: 5px; }
    .options { margin-bottom: 5px; }
    .options label { margin-right: 15px; }
    textarea { width: 100%; resize: vertical; padding: 5px; margin-bottom: 5px; }
    input[type="file"] { margin-top: 5px; }
    .export-buttons { text-align: center; margin-top: 20px; }
    .export-buttons button { margin: 5px; padding: 10px 20px; font-size: 1em; }
  </style>
</head>
<body>
  <h1>Vernerunde - Sjekkliste</h1>
  <div class="container" id="checklist">
    <div class="section-title">Sjekkpunkter</div>

    <div id="check-items"></div>

    <div class="section-title">Signatur</div>
    <div class="check-item">
      <div class="question">Signert av (navn):<br>Signed by (name):</div>
      <input type="text" id="signatur-navn" placeholder="Fyll inn navn / Enter name">
    </div>
    <div class="check-item">
      <div class="question">Dato:<br>Date:</div>
      <input type="date" id="signatur-dato" value="">
    </div>
    <div class="check-item">
      <div class="question">Last opp signatur (valgfritt):<br>Upload signature (optional):</div>
      <input type="file" accept="image/*" id="signatur-fil">
    </div>

    <div class="export-buttons">
      <button onclick="exportPDF()">Last ned PDF</button>
      <button onclick="exportExcel()">Last ned Excel</button>
    </div>
  </div>

  <script>
    document.getElementById("signatur-dato").valueAsDate = new Date();

    const checkpoints = [
      ["Finnes et godkjent brannalarm-anlegg?", "Is there an approved fire alarm system?"],
      ["Er det installert adgangskontroll?", "Is access control installed?"],
      ["Er rømningsveier tydelig merket og med ledelys?", "Are escape routes clearly marked and lit?"],
      ["Er stillaser og stiger forsvarlig montert?", "Are scaffolding and ladders properly installed?"],
      ["Brukes påkrevd verneutstyr?", "Is the required protective equipment used?"],
      ["Er lysarmaturene PCB-frie?", "Are the light fixtures PCB-free?"],
      ["Er det tilstrekkelig lys iht. norm?", "Is lighting sufficient according to standards?"],
      ["Gir armaturene flimmerfritt lys?", "Do fixtures provide flicker-free light?"],
      ["Har armaturene individuell justeringsmulighet?", "Do the fixtures allow individual adjustment?"],
      ["Er det installert overspenningsvern?", "Are surge protectors installed?"]
    ];

    const container = document.getElementById("check-items");
    checkpoints.forEach((cp, i) => {
      const div = document.createElement("div");
      div.className = "check-item";
      div.innerHTML = `
        <div class="question">${cp[0]}<br>${cp[1]}</div>
        <div class="options">
          <label><input type="radio" name="q${i}" value="Ja"> Ja</label>
          <label><input type="radio" name="q${i}" value="Nei"> Nei</label>
        </div>
        <textarea placeholder="Merknad..."></textarea>
        <input type="file" accept="image/*">
      `;
      container.appendChild(div);
    });

    async function exportPDF() {
      const checklist = document.getElementById("checklist");

      const signNavn = document.getElementById("signatur-navn").value;
      const signDato = document.getElementById("signatur-dato").value;
      const signFil = document.getElementById("signatur-fil").files[0];

      const tempDiv = document.createElement("div");
      tempDiv.style.marginTop = "20px";
      tempDiv.innerHTML = `<strong>Signert av:</strong> ${signNavn || "(ikke oppgitt)"}<br>
        <strong>Dato:</strong> ${signDato || "(ikke oppgitt)"}<br>`;

      if (signFil) {
        const img = document.createElement("img");
        img.src = URL.createObjectURL(signFil);
        img.style.maxWidth = "200px";
        img.style.marginTop = "10px";
        tempDiv.appendChild(img);
      }

      checklist.appendChild(tempDiv);

      const canvas = await html2canvas(checklist, { scale: 2 });
      const imgData = canvas.toDataURL("image/jpeg", 1.0);
      const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
      const imgProps = pdf.getImageProperties(imgData);
      const pdfWidth = pdf.internal.pageSize.getWidth();
      const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
      pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);
      pdf.save("vernerunde.pdf");

      checklist.removeChild(tempDiv);
    }

    function exportExcel() {
      const wb = XLSX.utils.book_new();
      const ws_data = [["Spørsmål", "Ja/Nei", "Merknad", "Bilde"]];
      const items = document.querySelectorAll(".check-item");

      let remaining = 0;
      let done = 0;

      items.forEach((item, idx) => {
        const q = item.querySelector(".question")?.innerText || "";
        const a = item.querySelector("input[type=radio]:checked")?.value || "";
        const note = item.querySelector("textarea")?.value || "";
        const file = item.querySelector("input[type=file]")?.files[0];

        if (file) {
          remaining++;
          const reader = new FileReader();
          reader.onload = function (e) {
            ws_data.push([q, a, note, e.target.result]);
            done++;
            if (done === remaining) finishExcel(wb, ws_data);
          };
          reader.readAsDataURL(file);
        } else {
          ws_data.push([q, a, note, ""]);
        }
      });

      // Add signature info
      const signName = document.getElementById("signatur-navn").value;
      const signDate = document.getElementById("signatur-dato").value;
      const signFile = document.getElementById("signatur-fil").files[0];
      if (signFile) {
        remaining++;
        const reader = new FileReader();
        reader.onload = function (e) {
          ws_data.push(["Signatur", signName, signDate, e.target.result]);
          done++;
          if (done === remaining) finishExcel(wb, ws_data);
        };
        reader.readAsDataURL(signFile);
      } else {
        ws_data.push(["Signatur", signName, signDate, ""]);
      }

      if (remaining === 0) finishExcel(wb, ws_data);
    }

    function finishExcel(wb, data) {
      const ws = XLSX.utils.aoa_to_sheet(data);
      XLSX.utils.book_append_sheet(wb, ws, "Sjekkliste");
      XLSX.writeFile(wb, "vernerunde.xlsx");
    }
  </script>
</body>
</html>
